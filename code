#This code is prepared to help with Trial 5 of the thesis: Age and urinary microbial diversity in women with and without TC

### Dowloading NCBI Data for QIIME2 Tutorial ###

#00. Set-up

        #1. Mini Conda: 
        Conda --version
          #conda 24.1.0

        #2. BioConda: https://bioconda.github.io/user/insta...
        conda config --show channels
        
        #3. GNU Parallel: https://www.gnu.org/software/parallel/
        parallel --version
          #20240122
            
        #4. Install SRA tools https://github.com/ncbi/sra-tools/wiki/02.-Installing-SRA-Toolkit#the-sra-toolkit-provides-64-bit-binary-installations-for-the-ubuntu-and-centos-linux-distributions-for-mac-os-x-and-for-windows
        curl --output sratoolkit.tar.gz https://ftp-trace.ncbi.nlm.nih.gov/sra/sdk/current/sratoolkit.current-mac64.tar.gz
        tar -vxzf sratoolkit.tar.gz
        export PATH=$PATH:$PWD/sratoolkit.3.0.10-mac-x86_64/bin #be sure to change the version & mac title to the one that's on your computer
        which fastq-dump #testing functionality
        fastq-dump --stdout -X 2 SRR390728 #testing functionality 

        #5. QIIME2: https://docs.qiime2.org/2020.8/install/native/#install-qiime-2-within-a-conda-environment
        qiime --version 
          #2023.9.1

    #Create Directory
    mkdir Thesis5
    cd Thesis5

#01. DONE ALREADY Go to the NCBI Studies Browser
    #1. Downloaded the acession list from NCBI: SRR_Acc_List.txt

#02. Create Metadata TSV for QIIME2
  #qiime documentation for atacoma soil: https://docs.qiime2.org/2023.9/tutorials/atacama-soils/
  #sample google sheet: https://docs.google.com/spreadsheets/d/1MNh2ZFX4rRhtDc5FjVDlzhZ4FoWKl5pgC4J5ukV6Nh4/edit?usp=sharing
    #1. Copy and paste all columns and relevant rows into a new googlesheet
    #2. Add a row below the header row
    #3. Move barcode column to second column in the google sheets
    #4. Rename the "Run" column as "sample-id"
    #5. Add #q2:types values to each column (i.e., "categorical", "numeric")
    #6. Download as .tsv (tab separated value)
    #7. Rename metadata to gaspari-metadata.tsv

#03. Begin Data Download
    #Download the data in parallel
        cat SRR_Acc_List.txt  | parallel -j0 prefetch {}

    #Move all .sra files out of their folders and into the working directory
        find /Users/meganleinenbach/Documents/Thesis5 -type f -name "*.sra" -exec mv {} /Users/meganleinenbach/Documents/Thesis5 \;

    #Delete all empty folders in the working directory
        find . -type d -empty -delete

#04. Convert all .sra files into fastq files
    ls *.sra | parallel -j0 fastq-dump --split-files --origfmt {}

    #Move .fastq and .sra file types into their own folders
        mkdir fastq
        mv *.fastq fastq
        mkdir sra
        mv *.sra sra

#05. Prepare files for QIIME2 import

    cd fastq
    mkdir manifest

    #Create Manifest file (https://docs.qiime2.org/2020.8/tutorials/importing/#fastq-manifest-formats)

    	#create header
				echo "# paired-end PHRED 33 fastq manifest file for forward and reverse reads" > manifest1.txt
				echo -e "sample-id\tforward-absolute-filepath\treverse-absolute-filepath" >> manifest1.txt

			#create text file with ID path to forward and path to reverse separated by tabs
				 ls *.fastq | cut -d "_" -f 1 | sort | uniq | parallel -j0 --keep-order 'echo -e "{/}\t"$PWD"/{/}_1.fastq\t"$PWD"/{/}_2.fastq"' | tr -d "'" > manifest2.txt
			
      #create full file
				cat manifest1.txt manifest2.txt > manifest/manifest.tsv
		
      #Delete text files
  			rm *.txt
  			cd ..  

#06. Begin Qiime data import 
      #determine number of cores
        sysctl -n hw.ncpu
      #set number of cores
  			NCORES=8

      #import metagenomic data
        qiime tools import \
        --type 'SampleData[PairedEndSequencesWithQuality]' \
        --input-path fastq/manifest/manifest.tsv \
        --output-path 5-demux.qza \
        --input-format PairedEndFastqManifestPhred33V2
            
        qiime demux summarize --i-data 5-demux.qza --o-visualization 5-demux.qzv
        ### View Output

## truncate and trim based on what you see in the interactive quality plot of demux data

    time qiime dada2 denoise-paired \
        --i-demultiplexed-seqs 5-demux.qza \
        --p-trim-left-f 0 \
        --p-trim-left-r 0 \
        --p-trunc-len-f 161 \
        --p-trunc-len-r 109 \
        --o-table table-0.qza \
        --o-representative-sequences 5-asv-0.qza \
        --o-denoising-stats 5-denoising-stats-0.qza
    
## generate denoising stats

    qiime metadata tabulate \
      --m-input-file t3-denoising-stats-0.qza \
      --o-visualization t3-denoising-stats-0.qzv

## get your first summarized feature table 


    qiime feature-table summarize \
      --i-table table-0.qza \
      --m-sample-metadata-file meta_data.tsv \
      --o-visualization table-0.qzv
    qiime feature-table tabulate-seqs \
      --i-data asv-0.qza \
      --o-visualization asv-0.qzv

## download the taxonomic classifier
    
    wget \
  -O 'gg-13-8-99-nb-classifier.qza' \
  'https://docs.qiime2.org/jupyterbooks/cancer-microbiome-intervention-tutorial/data/030-tutorial-downstream/020-taxonomy/gg-13-8-99-nb-classifier.qza'

## assign taxonomy info to asv sequences
    
    qiime feature-classifier classify-sklearn \
      --i-classifier gg-13-8-99-nb-classifier.qza \
      --i-reads t3-asv-0.qza \
      --o-classification t3-taxonomy.qza

## generate summary of the asv file 

    qiime metadata tabulate \
      --m-input-file t3-taxonomy.qza \
      --o-visualization t3-taxonomy.qzv

##Filtering your feature table - you shoudl go through these steps and make sure there aren't more filtering steps that you want to add to make sure there aren't any samples in your feature table that you haven't included in metadata. 

    #filter out everything missing a phylum 
    qiime taxa filter-table \
      --i-table t3-table-0.qza \
      --i-taxonomy t3-taxonomy.qza \
      --p-mode contains \
      --p-include p__ \
      --p-exclude 'p__;,Chloroplast,Mitochondria' \
      --o-filtered-table t3-table-1.qza

    #summarize into human readable form 
    qiime feature-table summarize \
      --i-table t3-table-1.qza \
      --m-sample-metadata-file feb27_meta.tsv \
      --o-visualization t3-table-1.qzv

    #remove asv sequences that are no longer in the table 
    qiime feature-table filter-seqs \
      --i-data t3-asv-0.qza \
      --i-table t3-table-1.qza \
      --o-filtered-data t3-asv-1.qza

#Create taxa barplot 

    qiime taxa barplot \
      --i-table table-1.qza \
      --i-taxonomy taxonomy.qza \
      --m-metadata-file meta_data.tsv \
      --o-visualization taxa-bar-plots-1.qzv

#Create phylogeny 

    qiime phylogeny align-to-tree-mafft-fasttree \
      --i-sequences t3-asv-1.qza \
      --output-dir t3-phylogeny-align-to-tree-mafft-fasttree

#Identify an even sampling depth - You want to choose a depth that works for both your alpha and beta data

    #alpha rarefaction for shannon 
    qiime diversity alpha-rarefaction \
      --i-table t3-table-1.qza \
      --p-metrics shannon \
      --m-metadata-file feb27_meta.tsv \
      --p-max-depth 750 \
      --o-visualization t4-shannon-rarefaction-plot.qzv

    #alpha rarefaction for observed features 
    qiime diversity alpha-rarefaction \
      --i-table t3-table-1.qza \
      --i-phylogeny rooted_tree.qza \
      --p-max-depth 1000 \
      --m-metadata-file feb27_meta.tsv \
      --o-visualization alpha-rarefaction.qzv

    #alpha rarefaction for evenness 
    qiime diversity alpha-rarefaction \
      --i-table t3-table-1.qza \
      --i-phylogeny rooted_tree.qza \
      --p-max-depth 1000 \
      --p-metrics pielou_e \
      --m-metadata-file feb27_meta.tsv \
      --o-visualization evenness-alpha-rarefaction.qzv

    #beta rarefaction for braycurtis
    qiime diversity beta-rarefaction \
      --i-table t3-table-1.qza \
      --p-metric braycurtis \
      --p-clustering-method nj \
      --p-sampling-depth 550 \
      --m-metadata-file feb27_meta.tsv \
      --o-visualization t4-braycurtis-rarefaction-plot.qzv

    #beta rarefaction for braycurtis
    qiime diversity beta-rarefaction \
      --i-table t3-table-1.qza \
      --p-metric braycurtis \
      --p-clustering-method nj \
      --p-sampling-depth 650 \
      --m-metadata-file feb27_meta.tsv \
      --o-visualization t4c-braycurtis-rarefaction-plot.qzv


    #beta rarefaction for weighted unifrac - chose to do this because we use uw in future pipeline
    qiime diversity beta-rarefaction \
      --i-table t3-table-1.qza \
      --i-phylogeny t3-phylogeny-align-to-tree-mafft-fasttree/t3-rooted_tree.qza \
      --p-metric weighted_unifrac \
      --p-clustering-method nj \
      --p-sampling-depth 650 \
      --m-metadata-file feb27_meta.tsv \
      --o-visualization t4b-wu-rarefaction-plot.qzv

    #beta rarefaction for unweighted unifrac - chose to do this because we use uw in future pipeline
    qiime diversity beta-rarefaction \
      --i-table t3-table-1.qza \
      --i-phylogeny t3-phylogeny-align-to-tree-mafft-fasttree/t3-rooted_tree.qza \
      --p-metric unweighted_unifrac \
      --p-clustering-method nj \
      --p-sampling-depth 3000 \
      --m-metadata-file feb27_meta.tsv \
      --o-visualization t4c-uu-rarefaction-plot.qzv

## sampling depths:
t4-braycurtis-rarefaction-plot.qzv: 550 (okay-good)
t4b-braycurtis-rarefaction-plot.qzv: 450 (bad)
t4-uu-rarefaction-plot.qzv: 550 (bad/awful)
t4-wu-rarefaction-plot.qzv: 550 (great) 
t4c-braycurtis-rarefaction-plot.qzv: 650 (good) 
t4b-wu-rarefaction-plot.qzv: 650 (great) 
t4b-uu-rarefaction-plot.qzv: 650 (bad/awful)
t4c-uu-rarefaction-plot.qzv: 3000 (bad/awful)

# chose a sampling depth of 650. 

#Obtain core diversity metrics -- are there any other diversity metrics you'd like to add? evenness? chao 1? 
    
    #at chosen sampling depth based on the rarefactin info you gathered from above 
    qiime diversity core-metrics-phylogenetic \
      --i-phylogeny t3-phylogeny-align-to-tree-mafft-fasttree/t3-rooted_tree.qza \
      --i-table t3-table-1.qza \
      --p-sampling-depth 650 \
      --m-metadata-file feb27_meta.tsv \
      --output-dir t4-diversity-core-metrics-phylogenetic

#Get alpha diversity visualizations
    
    qiime diversity alpha-group-significance \
      --i-alpha-diversity t4-diversity-core-metrics-phylogenetic/observed_features_vector.qza \
      --m-metadata-file feb27_meta.tsv \
      --o-visualization t4-alpha-group-sig-obs-feats.qzv


#Get ordination plots 

  qiime diversity umap \
    --i-distance-matrix t4-diversity-core-metrics-phylogenetic/unweighted_unifrac_distance_matrix.qza \
    --o-umap t4-uu-umap.qza
  
  qiime diversity umap \
    --i-distance-matrix t4-diversity-core-metrics-phylogenetic/weighted_unifrac_distance_matrix.qza \
    --o-umap t4-wu-umap.qza

#Create your expanded metadata (this will be useful for putting your values into the table) 

    qiime metadata tabulate \
      --m-input-file feb27_meta.tsv t4-uu-umap.qza t4-diversity-core-metrics-phylogenetic/faith_pd_vector.qza t4-diversity-core-metrics-phylogenetic/evenness_vector.qza t4-diversity-core-metrics-phylogenetic/shannon_vector.qza \
      --o-visualization t4-expanded-metadata-summ.qzv

#Get second round of taxa barplots

  #run to see if you have any extraneous samples remaining in your feature table. 
  qiime taxa barplot \
      --i-table t3-table-1.qza \
      --i-taxonomy t3-taxonomy.qza \
      --m-metadata-file feb27_meta.tsv t4-uu-umap.qza t4-diversity-core-metrics-phylogenetic/faith_pd_vector.qza t4-diversity-core-metrics-phylogenetic/evenness_vector.qza t4-diversity-core-metrics-phylogenetic/shannon_vector.qza \
      --o-visualization t4-taxa-bar-plots-2.qzv

      # filtered out samples with fewer than 650 frequences to 
         qiime feature-table filter-samples \
           --i-table t3-table-1.qza \
           --p-min-frequency 650 \
           --m-metadata-file feb27_meta.tsv \
           --o-filtered-table t4-table-2.qza

         # summarize into qzv file (it worked)  
          qiime feature-table summarize \
           --i-table t4-table-2.qza \
           --m-sample-metadata-file feb27_meta.tsv \
           --o-visualization t4-table-2.qzv

  qiime taxa barplot \
      --i-table t4-table-2.qza \
      --i-taxonomy t3-taxonomy.qza \
      --m-metadata-file feb27_meta.tsv t4-uu-umap.qza t4-diversity-core-metrics-phylogenetic/faith_pd_vector.qza t4-diversity-core-metrics-phylogenetic/evenness_vector.qza t4-diversity-core-metrics-phylogenetic/shannon_vector.qza \
      --o-visualization t4-taxa-bar-plots-2.qzv

DONE! Move things into your tables motherfucker :) 


Redo with the t4-table-2.qza files 

##filter out asvs that were removed 
qiime feature-table filter-seqs \
      --i-data t3-asv-1.qza \
      --i-table t4-table-2.qza \
      --o-filtered-data t4-asv-2.qza

## tabulate sequences 

    qiime feature-table tabulate-seqs \
      --i-data t4-asv-2.qza \
      --o-visualization t4-asv-2.qzv

## assign taxonomy info to asv sequences
    
    qiime feature-classifier classify-sklearn \
      --i-classifier gg-13-8-99-nb-classifier.qza \
      --i-reads t4-asv-2.qza \
      --o-classification t4-taxonomy.qza

## generate summary of the asv file 

    qiime metadata tabulate \
      --m-input-file t4-taxonomy.qza \
      --o-visualization t4-taxonomy.qzv

#Create taxa barplot 

    qiime taxa barplot \
      --i-table t4-table-2.qza \
      --i-taxonomy t4-taxonomy.qza \
      --m-metadata-file feb27_meta.tsv \
      --o-visualization t4-taxa-bar-plots-3.qzv

#Create phylogeny 

    qiime phylogeny align-to-tree-mafft-fasttree \
      --i-sequences t4-asv-2.qza \
      --output-dir t4-phylogeny-align-to-tree-mafft-fasttree

# chose a sampling depth of 650. 
#Obtain core diversity metrics -- are there any other diversity metrics you'd like to add? evenness? chao 1? 
    
    #at chosen sampling depth based on the rarefactin info you gathered from above 
    qiime diversity core-metrics-phylogenetic \
      --i-phylogeny t4-phylogeny-align-to-tree-mafft-fasttree/rooted_tree.qza \
      --i-table t4-table-2.qza \
      --p-sampling-depth 650 \
      --m-metadata-file feb27_meta.tsv \
      --output-dir t4b-diversity-core-metrics-phylogenetic

#Get alpha diversity visualizations
    
    qiime diversity alpha-group-significance \
      --i-alpha-diversity t4b-diversity-core-metrics-phylogenetic/observed_features_vector.qza \
      --m-metadata-file feb27_meta.tsv \
      --o-visualization t4b-alpha-group-sig-obs-feats.qzv


#Get ordination plots 

  qiime diversity umap \
    --i-distance-matrix t4b-diversity-core-metrics-phylogenetic/unweighted_unifrac_distance_matrix.qza \
    --o-umap t4b-uu-umap.qza
  
  qiime diversity umap \
    --i-distance-matrix t4b-diversity-core-metrics-phylogenetic/weighted_unifrac_distance_matrix.qza \
    --o-umap t4b-wu-umap.qza

#Create your expanded metadata (this will be useful for putting your values into the table) 

    qiime metadata tabulate \
      --m-input-file feb27_meta.tsv t4b-uu-umap.qza t4b-diversity-core-metrics-phylogenetic/faith_pd_vector.qza t4b-diversity-core-metrics-phylogenetic/evenness_vector.qza t4b-diversity-core-metrics-phylogenetic/shannon_vector.qza t4b-diversity-core-metrics-phylogenetic/observed_features_vector.qza \
      --o-visualization t4b-expanded-metadata-summ.qzv


##get chao 1
qiime diversity alpha \
      --i-table t4-table-2.qza \
      --p-metric chao1 \
      --o-alpha-diversity chao1.qza

## summarize
qiime metadata tabulate \
  --m-input-file chao1.qza \
  --o-visualization chao1.qzv


##summarize uu map 
qiime metadata tabulate \
  --m-input-file t4b-wu-umap.qza \
  --o-visualization t4b-wu-umap.qzv

##get beta diversity statistics 
qiime diversity beta \
  --i-table t4-table-2.qza \
  --p-metric braycurtis \
  --o-distance-matrix braycurtis.qza
#I cannot summarize this and I'm not sure that I'm going to be able to use it for anything. 

#see if there are beta diversity differences by country 
qiime diversity beta-group-significance \
  --i-distance-matrix t4b-diversity-core-metrics-phylogenetic/unweighted_unifrac_distance_matrix.qza \
  --m-metadata-file feb27_meta.tsv \
  --m-metadata-column geo_loc_name_country \
  --o-visualization t4b-diversity-core-metrics-phylogenetic/unweighted-unifrac-donor-significance.qzv

qiime diversity beta-group-significance \
  --i-distance-matrix t4b-diversity-core-metrics-phylogenetic/weighted_unifrac_distance_matrix.qza \
  --m-metadata-file feb27_meta.tsv \
  --m-metadata-column geo_loc_name_country \
  --o-visualization t4b-diversity-core-metrics-phylogenetic/weighted-unifrac-donor-significance.qzv


qiime diversity beta-group-significance \
  --i-distance-matrix t4b-diversity-core-metrics-phylogenetic/bray_curtis_distance_matrix.qza \
  --m-metadata-file feb27_meta.tsv \
  --m-metadata-column geo_loc_name_country \
  --o-visualization t4b-diversity-core-metrics-phylogenetic/bray-curtis-country-significance.qzv


#alpha group significance 

#redo evennness 

qiime diversity-lib pielou-evenness \
    --i-table t4-table-2.qza \
    --o-vector pielou-vector.qza

qiime diversity alpha-group-significance \
 --i-alpha-diversity pielou-vector.qza \
 --m-metadata-file feb27_meta.tsv \
 --o-visualization t4b-diversity-core-metrics-phylogenetic/evenness_statistics.qzv

#chao 1 significance
qiime diversity alpha-group-significance \
 --i-alpha-diversity chao1.qza \
 --m-metadata-file feb27_meta.tsv \
 --o-visualization t4b-diversity-core-metrics-phylogenetic/chao1-statistics.qzv
